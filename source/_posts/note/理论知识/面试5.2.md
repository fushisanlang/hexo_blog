---
title: 面试问题记录 五/三 - redis 哨兵
tags:
  - 面试
  - redis
categories:
  - note
date: 2022-02-21 02:00:00
---

### Redis 哨兵作用
主从复制当master出现故障时，需要手动切换master。哨兵模式就是为了解决手动切换这个问题。Redis2.8中提供了哨兵工具，来实现自动化的系统监控和故障恢复。哨兵是一个独立的进程，作为进程，它会独立运行。其原理是哨兵通过发送命令，等待Redis服务器响应，从而监控运行多个Redis实例。

哨兵通过发送命令，让Redis服务器返回运行状态，包括master和slave。
当哨兵（Sentinel）检测到master宕机，会自动将slave切换成master。然后通过发布订阅模式通知其他的slave。让其他slave切换主机。 

### 故障自动切换
假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行 failover 过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象成为主观下线。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行 failover 操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为客观下线。这样对于客户端而言，一切都是透明的。 

### 工作机制  
*  每个Sentinel（哨兵）进程以每秒钟一次的频率向整个集群中的 Master 主服务器，Slave 从服务器以及其他Sentinel（哨兵）进程发送一个 PING 命令。
*  如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被 Sentinel（哨兵）进程标记为主观下线（SDOWN）
*  如果一个 Master 主服务器被标记为主观下线（SDOWN），则正在监视这个 Master 主服务器的所有 Sentinel（哨兵）进程要以每秒一次的频率确认 Master 主服务器的确进入了主观下线状
*  当有足够数量的 Sentinel（哨兵）进程（大于等于配置文件指定的值）在指定的时间范围内确认 Master 主服务器进入了主观下线状态（SDOWN）， 则 Master 主服务器会被标记为客观下线（ODOWN）
*   在一般情况下， 每个 Sentinel（哨兵）进程会以每 10 秒一次的频率向集群中的所有 Master 主服务器、Slave 从服务器发送 INFO 命令。
*   当 Master 主服务器被 Sentinel（哨兵）进程标记为客观下线（ODOWN）时，Sentinel（哨兵）进程向下线的 Master 主服务器的所有 Slave 从服务器发送 INFO 命令的频率会从 10 秒一次改为每秒一次。
*   若没有足够数量的 Sentinel（哨兵）进程同意 Master主服务器下线， Master 主服务器的客观下线状态就会被移除。若 Master 主服务器重新向 Sentinel（哨兵）进程发送 PING 命令返回有效回复，Master主服务器的主观下线状态就会被移除。

### 为什么要那么多哨兵组成网络
 当只有1个Sentinel的时候，如果这个Sentinel挂掉了就不能实现故障的自动切换。在Sentinel网络中，只要还有1个 Sentinel活着，就可以实现故障的自动切换。  

 ### Sentinel（哨兵）优点
* 哨兵模式是基于主从的，所有主从的优点，哨兵模式都具有。

* 主从可以自动切换，系统更健壮，高可用性。（可以看做自动版的主从复制）

### Sentinel（哨兵）缺点
因为只有1个master，较难支持在线扩容，在集群容量达到上限时，在线扩容很复杂。

